var phantom = require('phantom');
    USERNAME = process.env.GOOGLE_USERNAME,
    PASSWORD = process.env.GOOGLE_PASSWORD;

function authenticate(page) {  
  page.evaluate(function() {
    return !!document.getElementById('Email');
  }, function(emailFieldExists){
    if(emailFieldExists){
      page.evaluate(function(user, pass) {
        document.getElementById('Email').value = user;
        document.getElementById('Passwd').value = pass;
        document.getElementById('signIn').click();
      }, function(result){}, USERNAME, PASSWORD);
    }
  });
}

function initializeHangout(page, success, failure){
  page.evaluate(function() {
    return document.location.href;
  }, function(href){
    /\/hangouts\/_\/[a-z0-9]+$/.test(href) ? success(href) : failure();
  });
}

function finish(phantom, page){
  if(page)
    page.release();

  if(phantom)
    phantom.exit();
}

module.exports = {
  create: function(success, failure) {
    phantom.create(function(ph) {
      return ph.createPage(function(page) {
        return page.open("https://plus.google.com/hangouts/_/", function(status) {
          var tries = 0,
              _success = success,
              _failure = failure,
              retry;
          
          success = function(href){
            console.log("hangout created at " + href);
            finish(ph, page);
            _success(href);
          }

          failure = function(){
            
            if(tries++ > 15){
              console.log("hangout failed");
              finish(ph, page);
              _failure();
            }else{
              console.log("hangout retry");
              setTimeout(retry, 1000);
            }
          }

          retry = function(){
            initializeHangout(page, success, failure)
          }

          authenticate(page);
          initializeHangout(page, success, failure);
        });
      });
    });
  }
}